<!DOCTYPE html>
<html>
<head>
    <title>Towers Battle</title>
    <style>
        canvas {
            border: 1px solid black;
            display: block;
            margin: 0 auto;
        }
        #info {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 10px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/brython@3.11.0/brython.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/brython@3.11.0/brython_stdlib.js"></script>
</head>
<body onload="brython()">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div id="info">
        <p>Игрок: Золото: <span id="gold1">0</span> | Жизни: <span id="hp1">100</span> | Очки: <span id="score1">0</span></p>
        <p>ИИ: Золото: <span id="gold2">0</span> | Жизни: <span id="hp2">100</span></p>
        <p>Кнопки: Лечение (100з = 50ж), Пушка (100/200/300з), Улучшение (150з)</p>
    </div>
    <script type="text/python">
from browser import document, window, timer
import random
import math

canvas = document["gameCanvas"]
ctx = canvas.getContext("2d")

# Класс для пушек
class Cannon:
    def __init__(self, x, y, damage, speed, color):
        self.x = x
        self.y = y
        self.damage = damage
        self.speed = speed
        self.color = color
        self.cooldown = 0  # Начало с 0 для одновременной стрельбы

# Класс для ядер
class Projectile:
    def __init__(self, x, y, dx, damage, color):
        self.x = x
        self.y = y
        self.dx = dx
        self.damage = damage
        self.color = color

# Инициализация игры
towers = [{"x": 150, "hp": 100, "width": 60, "height": 250}, {"x": 650, "hp": 100, "width": 60, "height": 250}]
gold = [0, 0]
score = 0
projectiles = []
cannons = [
    [Cannon(150, 350, 1, 3, "darkgreen")],
    [Cannon(650, 350, 1, -3, "darkred")]
]
game_over = False
gold_timer = 0

# Сенсорные кнопки
buttons = [
    {"x": 200, "y": 450, "w": 120, "h": 80, "action": "heal", "label": "Лечение"},
    {"x": 340, "y": 450, "w": 120, "h": 80, "action": "buy_cannon", "label": "Пушка"},
    {"x": 480, "y": 450, "w": 120, "h": 80, "action": "upgrade", "label": "Улучшение"}
]

# Отрисовка
def draw():
    global game_over, gold_timer, score
    if game_over:
        ctx.fillStyle = "black"
        ctx.font = "40px Arial"
        winner = "Игрок" if towers[1]["hp"] <= 0 else "ИИ"
        ctx.fillText(f"Игра окончена! Победил {winner}!", 200, 300)
        ctx.fillText(f"Очки: {score}", 300, 350)
        return

    ctx.clearRect(0, 0, canvas.width, canvas.height)

    # Мультяшные башни
    for i, tower in enumerate(towers):
        ctx.fillStyle = "green" if i == 0 else "red"
        ctx.beginPath()
        ctx.arc(tower["x"], 100 + tower["height"], tower["width"] // 2, math.pi, 0)  # Полукруг сверху
        ctx.lineTo(tower["x"] + tower["width"] // 2, 100 + tower["height"])
        ctx.lineTo(tower["x"] + tower["width"] // 2, 100)
        ctx.lineTo(tower["x"] - tower["width"] // 2, 100)
        ctx.closePath()
        ctx.fill()
        ctx.fillStyle = "white"  # Глаза
        ctx.beginPath()
        ctx.arc(tower["x"] - 15, 150, 5, 0, 2 * math.pi)
        ctx.arc(tower["x"] + 15, 150, 5, 0, 2 * math.pi)
        ctx.fill()
        ctx.fillStyle = "black"
        ctx.font = "20px Arial"
        ctx.fillText(f"Ж: {tower['hp']}", tower["x"] - 20, 80)

    # Мультяшные пушки
    for player_cannons in cannons:
        for cannon in player_cannons:
            ctx.fillStyle = cannon.color
            ctx.beginPath()
            ctx.arc(cannon.x, cannon.y, 15, 0, 2 * math.pi)  # Круглая пушка
            ctx.fill()
            ctx.fillStyle = "black"
            ctx.fillRect(cannon.x - 5, cannon.y - 20, 10, 15)  # Дуло
            cannon.cooldown += 1
            if cannon.cooldown >= 100:  # 5 секунд
                proj = Projectile(cannon.x, cannon.y, cannon.speed, cannon.damage, cannon.color)
                projectiles.append(proj)
                cannon.cooldown = 0

    # Ядра
    for proj in projectiles[:]:
        proj.x += proj.dx
        ctx.fillStyle = proj.color
        ctx.beginPath()
        ctx.arc(proj.x, proj.y, 5, 0, 2 * math.pi)
        ctx.fill()
        target = towers[1] if proj.dx > 0 else towers[0]
        if (target["x"] - target["width"] // 2 <= proj.x <= target["x"] + target["width"] // 2 and
            100 <= proj.y <= 100 + target["height"]):
            target["hp"] -= proj.damage
            if proj.dx > 0:
                score += proj.damage
            projectiles.remove(proj)
        elif proj.x < 0 or proj.x > canvas.width:
            projectiles.remove(proj)

    # Кнопки с картинками
    for btn in buttons:
        ctx.fillStyle = "lightblue" if btn["action"] == "buy_cannon" else "lightgreen"
        ctx.fillRect(btn["x"], btn["y"], btn["w"], btn["h"])
        ctx.strokeStyle = "black"
        ctx.lineWidth = 5
        ctx.strokeRect(btn["x"], btn["y"], btn["w"], btn["h"])
        ctx.fillStyle = "black"
        ctx.font = "20px Arial"
        ctx.fillText(btn["label"], btn["x"] + 10, btn["y"] + 70)
        # Картинки
        if btn["action"] == "heal":
            ctx.fillStyle = "red"
            ctx.beginPath()
            ctx.moveTo(btn["x"] + 60, btn["y"] + 20)
            ctx.arc(btn["x"] + 50, btn["y"] + 20, 10, 0, math.pi, True)
            ctx.arc(btn["x"] + 70, btn["y"] + 20, 10, 0, math.pi, True)
            ctx.fill()
        elif btn["action"] == "buy_cannon":
            ctx.fillStyle = "gray"
            ctx.fillRect(btn["x"] + 40, btn["y"] + 20, 40, 20)
            ctx.fillRect(btn["x"] + 60, btn["y"] + 10, 10, 20)
        elif btn["action"] == "upgrade":
            ctx.fillStyle = "green"
            ctx.beginPath()
            ctx.moveTo(btn["x"] + 50, btn["y"] + 30)
            ctx.lineTo(btn["x"] + 60, btn["y"] + 10)
            ctx.lineTo(btn["x"] + 70, btn["y"] + 30)
            ctx.fill()
            ctx.moveTo(btn["x"] + 70, btn["y"] + 30)
            ctx.lineTo(btn["x"] + 80, btn["y"] + 10)
            ctx.lineTo(btn["x"] + 90, btn["y"] + 30)
            ctx.fill()

    # Золото (4 единицы в секунду)
    gold_timer += 1
    if gold_timer >= 20:
        gold[0] += 4
        gold[1] += 4
        gold_timer = 0

    # Обновление интерфейса
    document["gold1"].text = str(gold[0])
    document["gold2"].text = str(gold[1])
    document["hp1"].text = str(towers[0]["hp"])
    document["hp2"].text = str(towers[1]["hp"])
    document["score1"].text = str(score)

    # ИИ (покупка пушек или здоровья)
    if gold[1] >= 100 and random.random() < 0.01:
        if random.random() < 0.5 and len(cannons[1]) < 4:
            costs = [100, 200, 300]
            cost = costs[len(cannons[1]) - 1] if len(cannons[1]) < 3 else 300
            if gold[1] >= cost:
                cannons[1].append(Cannon(650, 350 - len(cannons[1]) * 50, 1, -3, "darkred"))
                gold[1] -= cost
        elif gold[1] >= 100:
            towers[1]["hp"] += 50
            gold[1] -= 100

# Управление
def touchstart(evt):
    evt.preventDefault()
    touch = evt.touches[0]
    x, y = touch.clientX - canvas.offsetLeft, touch.clientY - canvas.offsetTop
    for btn in buttons:
        if (btn["x"] <= x <= btn["x"] + btn["w"] and btn["y"] <= y <= btn["y"] + btn["h"]):
            if btn["action"] == "heal" and gold[0] >= 100:
                towers[0]["hp"] += 50
                gold[0] -= 100
            elif btn["action"] == "buy_cannon" and len(cannons[0]) < 4:
                costs = [100, 200, 300]
                cost = costs[len(cannons[0]) - 1] if len(cannons[0]) < 3 else 300
                if gold[0] >= cost:
                    cannons[0].append(Cannon(150, 350 - len(cannons[0]) * 50, 1, 3, "darkgreen"))
                    gold[0] -= cost
            elif btn["action"] == "upgrade" and gold[0] >= 150:
                for cannon in cannons[0]:
                    cannon.damage += 1
                gold[0] -= 150

canvas.bind("touchstart", touchstart)

timer.set_interval(draw, 50)
    </script>
</body>
</html>
